<!DOCTYPE html>
<html>
<head>
	<title>APEX stream overlay</title>
	<style>
		body {
				overflow: hidden;
				margin: 0;
				color: #f0f0f0;
				font-size: 12.5vh;
				background: black;
		}

		table {
				width: 100vw;
				border-collapse: separate;
				border-spacing: 0 2vh;
				padding: 0 2vw;
		}

		tbody tr {
				background: #222;
		}

		th:first-child, td:first-child {
				text-align: left;
		}

		th, td {
				text-align: center;
				padding: 1vh 2vw;
		}

		th {
				font-size: 0.4em;
				padding: 0vh 1vw;
		}

		td:last-child {
			font-size: 0.4em
		}
	</style>
</head>
<body>
	<table>
		<thead>
			<tr>
				<!-- <th>Profile</th> -->
				<th></th>
				<th>Kills</th>
				<th>Dmg</th>
				<th>W</th>
			</tr>
		</thead>
		<tbody id="matches"></tbody>
	</table>
	<template id="match-log">
		<tr>
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		</tr>
	</template>
	<script type="text/javascript">
		const state = new Map();
		const matchesTable = document.getElementById("matches")
		const matchLogTemplate = document.getElementById("match-log")

		const url = new URL(window.location.href)
		const platform = url.searchParams.get("platform")
		const profile = url.searchParams.get("profile")

		const apiUri = platform && profile
			? `platform=${platform}&profile=${profile}`
			: ''

		const run = () => {
			// Update data
			fetch(`/api?${apiUri}`)
				.then((r) => r.json())
				.then((profiles) => {
					profiles.map(processData)
				})

			// trim excess to prevent memory leaks
			const matchLogs = matchesTable.querySelectorAll("tr")

			if( matchLogs.length > 5 ) {
				matchLogs.forEach((matchLog, offset) => {
					if( offset >= 5 ) {
						matchesTable.removeChild(matchLog)
					}
				})
			}
		}

		const buildMatchLog = (log, template) => (stats) => {
			const clone = document.importNode(template.content, true);
			const tds = clone.querySelectorAll("td");

			// tds[0].textContent = stats.Profile
			tds[0].textContent = stats.Legend
			tds[1].textContent = stats.Kills
			tds[2].textContent = stats.Damage
			tds[3].textContent = stats.Wins > 0 ? "YES" : "NO"

			// prepend to the list
			log.insertBefore(clone, log.firstChild)
		}

		const updateMatchLog = buildMatchLog(matchesTable, matchLogTemplate)

		const processData = ({ platform, profile, data }) => {
			const current = data.children[0]
			const currentStats = getStats(current.stats)

			const currentData = {
				Platform: platform,
				Profile: profile,
				Legend: getLegendName(current),
				Kills: currentStats.Kills || currentStats.SeasonKills,
				Damage: currentStats.Damage || currentStats.SeasonDamage,
				Wins: currentStats.Wins || currentStats.SeasonWins,
			}

			const oldData = state.get(profile) || currentData
			const difference = getDifference(oldData, currentData)

			if(isDifference(difference)) {
				const matchLog = Object.assign({
					Profile: profile,
					Legend: currentData.Legend,
				}, difference)

				console.log(
					(new Date()).toLocaleString(),
					matchLog
				)

				if(matchLog.changedLegend === false ) {
					updateMatchLog(matchLog)
				}
			}

			state.set(profile, currentData)
		}

		const getLegendName = (legend) => (
			legend.metadata.legend_name
		)

		const getStats = stats => stats
			.map(stat => ({
				key: stat.metadata.key,
				value: stat.value
			}))
			.reduce((prev, current) => Object.assign(prev, {
				[current.key]: current.value
			}), {})

		const getDifference = (prev, current) => prev.Legend !== current.Legend
			? {changedLegend: true, Kills: 0, Damage: 0, Wins: 0 }
			: {
				changedLegend: false,
				Kills: deNaNify(Math.max(0, current.Kills - prev.Kills)),
				Damage: deNaNify(Math.max(0, current.Damage - prev.Damage)),
				Wins: deNaNify(Math.max(0, current.Wins - prev.Wins)),
			}

		const isDifference = (diff) => (
			diff.changedLegend
			|| diff.Kills > 0
			|| diff.Damage > 0
			|| diff.Wins > 0
		)

		const deNaNify = (num) => isNaN(num) ? 0 : num

		// const LegendSpecificBanner = {
		// 	"LifeLine": {
		// 		"Specific1": "Droppod: Items for Squadmates"
		// 	}
		// }
	</script>
	<script>
		setInterval(run, 30000)
	</script>
</body>
</html>
